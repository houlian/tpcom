{include file="layouts/header" /}
  
  <div class="layui-body">
    <!-- 内容主体区域 -->
    <div class="" style="height: 50px;line-height: 50px;margin-bottom: 0;border-radius: 0;background-color: #fff;box-shadow: 0 1px 2px 0 rgba(0,0,0,.05);">
	    <div style="border-top: 1px solid #f6f6f6;padding: 0 15px;font-size: 0;height: 50px;line-height: 50px;margin-bottom: 0;border-radius: 0;">
		    <span class="layui-breadcrumb" >
			  <a href="" style="font-style: 微软雅黑;" >订&nbsp;单</a>
			  <a style=""><cite>代发订单</cite></a>
			</span>
	    </div>

	</div>

	<!-- 内容主体 -->
    <div style="padding: 15px;position: relative;margin: 0 auto;height: 90%;">
    	<div style="margin: -4.5px;">
    		<div style="padding: 7.5px;width: 100%;float: left;background-color: #fff;margin-bottom: 25px;height: 100%;">

    			<div class="layui-container" style="width: 100%;padding: 0 0px">
    				    			<!-- 搜索区域 -->
				  <div class="layui-row">
				    <div class="layui-col-md1">
				      <label style="font-size: 16px;font-family: 微软雅黑;">搜&nbsp;索&nbsp;：</label>
				    </div>

				    <div class="layui-col-md11">
				    	<div class="layui-row ">

					      	<div class="layui-col-md2" style="padding: 2px;">
					      		<div class="layui-row ">
				      				<div class="layui-col-md6" style="padding: 2px;">
						      		<input type="text" class="layui-input" id="name_sear" placeholder="取件人">
				      				</div>
				      				<div class="layui-col-md6" >
				      					<div class="layui-form">
							      			<select name="isred" lay-filter="isred" id="isred_sear">
									      		<option value="0">是否使用优惠券</option>
									        	<option value="2">使用优惠券</option>
									        	<option value="1">不使用优惠券</option>
									      	</select>
									    </div>
				      				</div>
					      		</div>
					      	</div>

					      	<div class="layui-col-md3" style="padding: 2px;">
					      		<div class="layui-row ">
				      				<div class="layui-col-md6" style="padding: 2px;">
						      		<input type="text" class="layui-input" id="timestart" placeholder="起始时间">
				      				</div>
				      				<div class="layui-col-md6" style="padding: 2px;">
						      		<input type="text" class="layui-input" id="timeend" placeholder="结束时间">
				      				</div>
					      		</div>
					      	</div>

					      	<div class="layui-col-md1" style="padding: 2px;">
							      <input type="text" name="title"  placeholder="请输入用户id" autocomplete="off" class="layui-input" id="userid">
					      	</div>
					      	<div class="layui-col-md1" style="padding: 2px;">
							      <input type="text" name="title"  placeholder="请输入取件码" autocomplete="off" class="layui-input" id="codeser">
					      	</div>
					      	<div class="layui-col-md1" style="padding: 2px;">
							      <input type="text" name="title"  placeholder="请输入联系电话" autocomplete="off" class="layui-input" id="phoneser">
					      	</div>

						    <div class="layui-col-md1" style="padding: 2px;">
						       <div class="layui-form">
							      	<select name="interest" lay-filter="aihao" id="status">
							      		<option value="0">状态</option>
							        	<option value="1">已发布</option>
							        	<option value="2">已接单</option>
							        	<option value="3">已完成</option>
							        	<option value="4">已取消</option>
							      	</select>
							    </div> 
						    </div>
							<div class="layui-col-md3" style="padding: 2px;">
								<div class="layui-btn-group">
					        		<button class="layui-btn" id="searchbtn">搜&nbsp;&nbsp;索</button>
					        		<button class="layui-btn" id="ordertake" >批量接单</button>
					        		<button class="layui-btn" id="orderfinish">批量完结</button>
					        		<button class="layui-btn" id="export">报表导出</button>

								</div>
						    </div>


				      	</div>
				    </div>
				 </div>

				 <div class="layui-row">
				 	<div class="layui-col-md2">
					      	
					</div>
					<div class="layui-col-md10">
					      		
					</div>

				 </div>

				</div>

				<hr>
				<!-- 表格区域 -->
				<div>
					<table id="tabledemo" lay-filter="tabledemo"></table>
				</div>


    		</div>

    	</div>

    </div>

  </div>



	  <script type="text/javascript">
	  	layui.use('layer', function(){
		  var layer = layui.layer;
		});
	  	layui.use(['form','table','laydate'], function(){
		  	var form = layui.form;
	    	var laydate = layui.laydate;


		//表格
		  var table = layui.table;
	  
		  table.render({
		    elem: '#tabledemo'
		    ,url:'/index/order/orderlist/'
		    ,cellMinWidth: 80 //全局定义常规单元格的最小宽度，layui 2.2.1 新增
		    ,cols: [[
		    	{type:'checkbox',rowspan: 2}
		      ,{field:'id', width:40, title: 'ID', sort: true,rowspan: 2}
		      ,{field:'userid', width:80, title: '用户id',rowspan: 2}
		      ,{field:'code',  title: '取件码', width:100,rowspan: 2}
		      ,{field:'paypoint',width:90, title: '使用积分',rowspan: 2}
		      ,{field:'isred', title: '使用优惠券', sort: true,rowspan: 2}
		      ,{field:'redcode', title: '优惠券码',rowspan: 2}
		      ,{field:'relpoint', title: '实际使用积分',rowspan: 2}
		      ,{field:'address_s', title: '取件点',rowspan: 2}
		      ,{title: '取件点',align: 'center',colspan: 4}

		      ,{field:'name', title: '取件人',rowspan: 2}
		      ,{field:'phone', title: '电话号码',width:120,rowspan: 2}
		      // ,{field:'address_e', title: '收货点', width:300}
		      ,{field:'note', title: '备注', width:150,rowspan: 2}
		      ,{field:'msg', title: '取件短信',rowspan: 2}
		      ,{field:'addtime', width:137, title: '添加时间', sort: true,rowspan: 2}
		      ,{field:'finishtime',  title: '完结时间', sort: true,rowspan: 2}
		      ,{field:'statustext',width:80, title: '状态',templet: '#statusTpl', sort: true,rowspan: 2}
		      ,{field:'',title:'操作',toolbar: '#barDemo',fixed: 'right',width:160,rowspan: 2}
		    ],
		    [
		    	{field:'addr_one', title: '南北区'}
		      ,{field:'addr_two', title: '园区'}
		      ,{field:'addr_three', title: '楼号'}
		      ,{field:'room', title: '宿舍号'}
		    ]]
		    ,response: {
  				statusCode: 200 //成功的状态码，默认：0
			} 
			,page: true
			,limit: 30
			,limits: [30,50,100,200]    
		  });

		  //搜索
		  $(document).on('click','#searchbtn',function(){
		  	//执行表格重载
		      table.reload('tabledemo', {
		        page: {
		          curr: 1 //重新从第 1 页开始
		        }
		        ,where: {
	            	userid: $('#userid').val(),
	            	phone: $('#phoneser').val(),
	            	code: $('#codeser').val(),
	            	status: $('#status').val(),
	            	timestart: $('#timestart').val(),
	            	isred: $('#isred_sear').val(),
	            	name: $('#name_sear').val(),
	            	timeend: $('#timeend').val()
		        }
		      });
		  });

 	  	//监听回车事件
		$(document).keyup(function(event) {
		  if (event.keyCode ==13) {
		    $("#searchbtn").trigger("click");
		  }
		});
		 //搜索报表导出
		  $(document).on('click','#export',function(){
		  	var url = '/index/order/orderexport?';
		  	url += "userid=" + $.trim($('#userid').val());
		  	url += "&status=" + $.trim($('#status').val());
		  	url += "&timestart=" + $.trim($('#timestart').val());
		  	url += "&timeend=" + $.trim($('#timeend').val());

		  	window.open(url);
		  });

		  	//时间组件
			laydate.render({
			    elem: '#timestart' //指定元素
			    ,type:'datetime'
			});
			laydate.render({
			    elem: '#timeend' //指定元素
			    ,type:'datetime'
			});



			//监听点击事件
		  	table.on('tool(tabledemo)', function(obj){ //注：tool是工具条事件名，test是table原始容器的属性 lay-filter="对应的值"
			  var data = obj.data; //获得当前行数据
			  var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
			  var tr = obj.tr; //获得当前行 tr 的DOM对象
			 
			  if(layEvent === 'detail'){ //查看
			  	window.open('/index/order/orderinfo?id=' + data.id);
			  } else if(layEvent === 'takeone'){ //接单
			  	var id = data.id;
			  	$.post('/index/order/takeone', {orderid: id}, function(data, textStatus, xhr) {
			  		/*optional stuff to do after success */
			  		if(data.code == 200){
			  			var span = $(tr).find('span[name="statustext"]')[0];
			  			$(span).removeClass();
			  			$(span).addClass('color_ok');
			  			$(span).text('已接单');
			  			$(tr).find('a[lay-event="takeone"]').remove();
				    	layer.msg(data.msg);
				  	}else{
					    layer.msg(data.msg);        
				  	}
			  	},"json");		  	
			  } else if(layEvent === 'cancelone'){ //编辑
			    //do something
			  	var id = data.id;
			  	$.post('/index/order/cancelone', {orderid: id}, function(data, textStatus, xhr) {
			  		/*optional stuff to do after success */
			  		if(data.code == 200){
			  			var span = $(tr).find('span[name="statustext"]')[0];
			  			$(span).removeClass();
			  			$(span).addClass('color_cancel');
			  			$(span).text('已取消');
			  			$(tr).find('a[lay-event="cancelone"]').remove();
				    	layer.msg(data.msg);
				  	}else{
					    layer.msg(data.msg);        
				  	}
			  	},"json");	
			  }else if(layEvent === 'finishone'){
		  		var id = data.id;
  				layer.confirm('确认要手动完结该订单吗?', {icon: 3, title:'提示'}, function(index){
	  			  	$.post('/index/order/finishorder', {id: id}, function(data, textStatus, xhr) {
				  		if(data.code == 200){
							var span = $(tr).find('span[name="statustext"]')[0];
				  			$(span).removeClass();
				  			$(span).addClass('color_finish');
				  			$(span).text('已完成');
				  			$(tr).find('a[lay-event="finishone"]').remove();
					    	layer.msg(data.msg);
					  	}else{
						    layer.msg(data.msg);        
					  	}
				  	},"json");	
				  	layer.close(index);
				});
			  }

			});

		  	//批量接单
		  $(document).on('click','#ordertake',function(){
	     	var checkStatus = table.checkStatus('tabledemo')
		      ,data = checkStatus.data;
		      if (data.length <= 0 ) {layer.msg("选择为空");return false;};
	      	var a = [];
	      	$.each(data,function(index, v) {
	      		a.push(v.id);
	      	});
	      	// layer.alert(JSON.stringify(a));
	      	$.post('/index/order/takemulti', {ids: JSON.stringify(a)}, function(data, textStatus, xhr) {
	      		/*optional stuff to do after success */
		  		if(data.code == 200){
					table.reload('tabledemo', {});//表格重载
			    	layer.alert(data.msg, {
					  skin: 'layui-layer-molv' //样式类名
					  ,closeBtn: 0
					});
			  	}else{
				    layer.msg(data.msg);        
			  	}
	      	},'json');
		  });		  
		  	//批量完结
		  $(document).on('click','#orderfinish',function(){
	     	var checkStatus = table.checkStatus('tabledemo')
		      ,data = checkStatus.data;
		      if (data.length <= 0 ) {layer.msg("选择为空");return false;};
	      	var a = [];
	      	$.each(data,function(index, v) {
	      		a.push(v.id);
	      	});
	      	// layer.alert(JSON.stringify(a));
	      	$.post('/index/order/finishmulti', {ids: JSON.stringify(a)}, function(data, textStatus, xhr) {
	      		/*optional stuff to do after success */
		  		if(data.code == 200){
					table.reload('tabledemo', {});//表格重载
			    	layer.alert(data.msg, {
					  skin: 'layui-layer-molv' //样式类名
					  ,closeBtn: 0
					});
			  	}else{
				    layer.msg(data.msg);        
			  	}
	      	},'json');
		  });	
		});

	</script>
  	<script type="text/html" id="barDemo">
	  <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="detail">查看</a>
	  {{# if(d.status == '1'){ }}
	  <a class="layui-btn layui-btn-xs takeone" data-v="{{d.id}}"  lay-event="takeone">接单</a>
	  <a class="layui-btn layui-btn-danger layui-btn-xs" data-v="{{d.id}}"  lay-event="cancelone">取消</a>
	  {{# } }}
	  {{# if(d.status == '2'){ }}
	  <a class="layui-btn layui-btn-xs finishone" data-v="{{d.id}}"  lay-event="finishone">完结</a>
	  <a class="layui-btn layui-btn-danger layui-btn-xs" data-v="{{d.id}}"  lay-event="cancelone">取消</a>
	  {{# } }}

	</script>
	<script type="text/html" id="statusTpl">
	  {{#  if(d.status === 1){ }}
	    <span name="statustext" class="">{{ d.statustext }}</span>
	  {{#  } else if(d.status === 2) { }}
	    <span name="statustext" class="color_ok">{{ d.statustext }}</span>
	  {{#  } else if(d.status === 3) { }}
	    <span name="statustext" class="color_finish">{{ d.statustext }}</span>
	  {{#  } else{ }}
	    <span name="statustext" class="color_cancel">{{ d.statustext }}</span>
	  {{#  } }}
	</script>
  <style type="text/css">
  	html {background-color: #f2f2f2;color: #666;}
  	.color_ok{color: #5FB878}
  	.color_finish{color: #01AAED}
  	.color_cancel{color: #FF5722}
  </style>
{include file="layouts/footer" /}